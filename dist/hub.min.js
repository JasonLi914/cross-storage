/**
 * cross-storage - Cross domain local storage
 *
 * @version   1.0.0
 * @link      https://github.com/zendesk/cross-storage
 * @author    Daniel St. Jules <danielst.jules@gmail.com>
 * @copyright Zendesk
 * @license   Apache-2.0
 */

!function(e){var t={};t.init=function(e,r){var n=!0;try{r||window.localStorage||(n=!1)}catch(s){n=!1}if(!n)try{return window.parent.postMessage("cross-storage:unavailable","*")}catch(s){return}t._permissions=e||[],t._storage=r||window.localStorage,t._installListener(),window.parent.postMessage("cross-storage:ready","*")},t._installListener=function(){var e=t._listener;window.addEventListener?window.addEventListener("message",e,!1):window.attachEvent("onmessage",e)},t._listener=function(e){var r,n,s,o,i;if(r="null"===e.origin?"file://":e.origin,"cross-storage:poll"===e.data)return window.parent.postMessage("cross-storage:ready",e.origin);if("cross-storage:ready"!==e.data){try{n=JSON.parse(e.data)}catch(a){return}if(n&&"string"==typeof n.method&&(s=n.method.split("cross-storage:")[1]))if(t._permitted(r,s))try{t["_"+s](n.params).then(function(e){t._postMessage(r,n,o,e)})}catch(a){o=a.message,t._postMessage(r,n,o,i)}else o="Invalid permissions for "+s,t._postMessage(r,n,o,i)}},t._postMessage=function(e,t,r,n){var s=JSON.stringify({id:t.id,error:r,result:n}),o="file://"===e?"*":e;window.parent.postMessage(s,o)},t._permitted=function(e,r){var n,s,o,i;if(n=["get","set","del","clear","getKeys"],!t._inArray(r,n))return!1;for(s=0;s<t._permissions.length;s++)if(o=t._permissions[s],o.origin instanceof RegExp&&o.allow instanceof Array&&(i=o.origin.test(e),i&&t._inArray(r,o.allow)))return!0;return!1},t._set=function(e){return Promise.resolve(t._storage.setItem(e.key,e.value))},t._get=function(e){var r,n,s;for(r=t._storage,n=[],s=0;s<e.keys.length;s++)n.push(r.getItem(e.keys[s]));return Promise.all(n).then(function(e){return e.length>1?e:e[0]})},t._del=function(e){for(var r=[],n=0;n<e.keys.length;n++)r.push(t._storage.removeItem(e.keys[n]));return Promise.all(r)},t._clear=function(){return Promise.resolve(t._storage.clear())},t._getKeys=function(){var e,r;return r=[],t._storage.length().then(function(n){for(e=0;n>e;e++)r.push(t._storage.key(e))}),Promise.all(r)},t._inArray=function(e,t){for(var r=0;r<t.length;r++)if(e===t[r])return!0;return!1},t._now=function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()},"undefined"!=typeof module&&module.exports?module.exports=t:"undefined"!=typeof exports?exports.CrossStorageHub=t:"function"==typeof define&&define.amd?define([],function(){return t}):e.CrossStorageHub=t}(this);