/**
 * cross-storage - Cross domain local storage
 *
 * @version   1.0.0
 * @link      https://github.com/zendesk/cross-storage
 * @author    Daniel St. Jules <danielst.jules@gmail.com>
 * @copyright Zendesk
 * @license   Apache-2.0
 */

!function(e){var t={};t.getItem=function(e,t){setTimeout(function(){try{t(null,window.localStorage.getItem(e))}catch(n){t(n)}},0)},t.setItem=function(e,t,n){setTimeout(function(){try{n(null,window.localStorage.setItem(e,t))}catch(o){n(o)}},0)},t.removeItem=function(e,t){setTimeout(function(){try{t(null,window.localStorage.removeItem(e))}catch(n){t(n)}},0)},t.key=function(e,t){setTimeout(function(){try{t(null,window.localStorage.key(e))}catch(n){t(n)}},0)},t.length=function(e){setTimeout(function(){try{e(null,window.localStorage.length)}catch(t){e(t)}},0)},t.clear=function(e){setTimeout(function(){try{e(null,window.localStorage.clear())}catch(t){e(t)}},0)};var n={};n.init=function(e,o){var r=!0;try{o||window.localStorage||(r=!1)}catch(i){r=!1}if(!r)try{return window.parent.postMessage("cross-storage:unavailable","*")}catch(i){return}n._storageAdapter=o||t,n._permissions=e||[],n._installListener(),window.parent.postMessage("cross-storage:ready","*")},n._installListener=function(){var e=n._listener;window.addEventListener?window.addEventListener("message",e,!1):window.attachEvent("onmessage",e)},n._listener=function(e){var t,o,r,i,a;if(t="null"===e.origin?"file://":e.origin,"cross-storage:poll"===e.data)return window.parent.postMessage("cross-storage:ready",e.origin);if("cross-storage:ready"!==e.data){try{o=JSON.parse(e.data)}catch(s){return}o&&"string"==typeof o.method&&(r=o.method.split("cross-storage:")[1],r&&(n._permitted(t,r)?n["_"+r](o.params,function(e,r){e?n._postMessage(t,o,e.message,a):n._postMessage(t,o,i,r)}):(i="Invalid permissions for "+r,n._postMessage(t,o,i,a))))}},n._postMessage=function(e,t,n,o){var r=JSON.stringify({id:t.id,error:n,result:o}),i="file://"===e?"*":e;window.parent.postMessage(r,i)},n._permitted=function(e,t){var o,r,i,a;if(o=["get","set","del","clear","getKeys"],!n._inArray(t,o))return!1;for(r=0;r<n._permissions.length;r++)if(i=n._permissions[r],i.origin instanceof RegExp&&i.allow instanceof Array&&(a=i.origin.test(e),a&&n._inArray(t,i.allow)))return!0;return!1},n._set=function(e,t){n._storageAdapter.setItem(e.key,e.value,t)},n._get=function(e,t){n._all(e.keys,"getItem",function(e,n){if(e)t(e);else{var o=n.length>1?n:n[0];o?t(null,o):t(null,null)}})},n._del=function(e,t){n._all(e.keys,"removeItem",function(e){e?t(e):t(null)})},n._clear=function(e,t){n._storageAdapter.clear(t)},n._getKeys=function(e,t){n._storageAdapter.length(function(e,o){if(e)t(e);else{for(var r=new Array(o),i=0;i<r.length;i++)r[i]=i;n._all(r,"key",t)}})},n._all=function(e,t,o){for(var r=new Array(e.length),i=e.length,a=0;a<e.length;a++)!function(a){n._storageAdapter[t](e[a],function(e,t){e?o(e):(r[a]=t,i-=1,0===i&&o(null,r))})}(a)},n._inArray=function(e,t){for(var n=0;n<t.length;n++)if(e===t[n])return!0;return!1},n._now=function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()},"undefined"!=typeof module&&module.exports?module.exports=n:"undefined"!=typeof exports?exports.CrossStorageHub=n:"function"==typeof define&&define.amd?define([],function(){return n}):e.CrossStorageHub=n}(this);